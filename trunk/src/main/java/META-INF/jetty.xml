<?xml version="1.0"?>
<!DOCTYPE Configure PUBLIC "-//Mort Bay Consulting//DTD Configure//EN" "http://www.eclipse.org/jetty/configure.dtd">
<Configure id="Server" class="org.eclipse.jetty.server.Server">
	<!-- =========================================================== -->
	<!-- Sequence of configurations to defining Plus features. -->
	<!-- =========================================================== -->
	<Array id="plusConfig" type="java.lang.String">
		<Item>org.eclipse.jetty.webapp.WebInfConfiguration</Item>
		<Item>org.eclipse.jetty.webapp.WebXmlConfiguration</Item>
		<Item>org.eclipse.jetty.webapp.MetaInfConfiguration</Item>
		<Item>org.eclipse.jetty.webapp.FragmentConfiguration</Item>
		<Item>org.eclipse.jetty.plus.webapp.EnvConfiguration</Item>
		<Item>org.eclipse.jetty.plus.webapp.PlusConfiguration</Item>
		<Item>org.eclipse.jetty.annotations.AnnotationConfiguration</Item>
		<Item>org.eclipse.jetty.webapp.JettyWebXmlConfiguration</Item>
		<Item>org.eclipse.jetty.webapp.TagLibConfiguration</Item>
	</Array>
	<!-- =========================================================== -->
	<!-- Apply plusConfig to all webapps for this Server -->
	<!-- =========================================================== -->
	<Call name="setAttribute">
		<Arg>org.eclipse.jetty.webapp.configuration</Arg>
		<Arg>
			<Ref id="plusConfig" />
		</Arg>
	</Call>
	<!-- =========================================================== -->
	<!-- Server Thread Pool -->
	<!-- =========================================================== -->
	<Set name="ThreadPool">
		<!-- Default queued blocking threadpool -->
		<New class="org.eclipse.jetty.util.thread.QueuedThreadPool">
			<Set name="minThreads">10</Set>
			<Set name="maxThreads">200</Set>
			<Set name="detailedDump">false</Set>
		</New>
	</Set>
    <!-- =========================================================== -->
    <!-- extra options                                               -->
    <!-- =========================================================== -->
	<Set name="stopAtShutdown">true</Set>
	<Set name="sendServerVersion">true</Set>
	<Set name="sendDateHeader">true</Set>
	<Set name="gracefulShutdown">1000</Set>
	<Set name="dumpAfterStart">false</Set>
	<Set name="dumpBeforeStop">false</Set>
	<!-- =========================================================== -->
	<!-- Define a server aware DB XA connection data source -->
	<!-- =========================================================== -->
	<New id="xaDataSource" class="org.eclipse.jetty.plus.jndi.Resource">
		<Arg></Arg>
		<Arg>jdbc/UGateDS</Arg>
		<Arg>
			<New id="atomikosDS" class="com.atomikos.jdbc.AtomikosDataSourceBean">
				<Set name="minPoolSize">2</Set>
				<Set name="maxPoolSize">50</Set>
				<Set name="xaDataSourceClassName">org.h2.jdbcx.JdbcDataSource</Set>
				<Set name="UniqueResourceName">jdbc/UGateDS</Set>
				<Set name="testQuery">SELECT 1 and SELECT 1 FROM DUAL</Set>
				<Get name="xaProperties">
					<Call name="setProperty">
						<!-- Must be upper case -->
						<Arg>URL</Arg>
						<Arg>jdbc:h2:~/ugate;AUTO_SERVER=TRUE;FILE_LOCK=SOCKET;TRACE_LEVEL_FILE=0;TRACE_LEVEL_SYSTEM_OUT=1</Arg>
					</Call>
					<Call name="setProperty">
						<Arg>user</Arg>
						<Arg>sa</Arg>
					</Call>
					<Call name="setProperty">
						<Arg>password</Arg>
						<Arg>sa</Arg>
					</Call>
				</Get>
			</New>
		</Arg>
	</New>
	<!-- =========================================================== -->
	<!-- Add a closer bean that will dispose of the DB DS -->
	<!-- =========================================================== -->
	<Ref id='Server'>
		<Call name="addBean">
			<Arg>
				<New class="org.eclipse.jetty.jndi.DataSourceCloser">
					<Arg>
						<Ref id="atomikosDS" />
					</Arg>
				</New>
			</Arg>
		</Call>
	</Ref>
	<!-- =========================================================== -->
	<!-- Add a mapping from name in web.xml to the environment -->
	<!-- =========================================================== -->
<!-- 	<New id="map1" class="org.eclipse.jetty.plus.jndi.Link"> -->
<!-- 		<Arg> -->
<!-- 			<Ref id='Server' /> -->
<!-- 		</Arg> -->
<!-- 		<Arg>jdbc/UGateDS</Arg> -->
<!-- 		<Arg>jdbc/UGateDS</Arg> -->
<!-- 	</New> -->
	<!-- =========================================================== -->
	<!-- Define an Atomikos transaction manager and initialize it -->
	<!-- =========================================================== -->
<!-- 	<New id="txMgr" class="com.atomikos.icatch.jta.UserTransactionManager"> -->
<!-- 		<Call name="init" /> -->
<!-- 	</New> -->
<!-- 	<New id="txMgrResource" class="org.eclipse.jetty.plus.jndi.Resource"> -->
<!-- 		<Arg></Arg> -->
<!-- 		<Arg>java:comp/env/UserTransactionManager</Arg> -->
<!-- 		<Arg> -->
<!-- 			<Ref id="txMgr" /> -->
<!-- 		</Arg> -->
<!-- 	</New> -->
	<!-- =========================================================== -->
	<!-- Define server transaction aware JTA implementation -->
	<!-- Atomikos < 3.x uses com.atomikos.icatch.jta.J2eeUserTransaction -->
	<!-- Use com.atomikos.icatch.jta.UserTransactionFactory ? -->
	<!-- =========================================================== -->
	<New id="tx" class="org.eclipse.jetty.plus.jndi.Transaction">
		<Arg>
			<New class="com.atomikos.icatch.jta.UserTransactionManager" />
		</Arg>
	</New>
	<!-- =========================================================== -->
	<!-- Web Application -->
	<!-- =========================================================== -->
<!-- 	<call name="addLifeCycle"> -->
<!-- 		<arg> -->
<!-- 			<new class="org.mortbay.jetty.deployer.WebAppDeployer"> -->
<!-- 				<set name="contexts"> -->
<!-- 					<ref id="Contexts"></ref> -->
<!-- 				</set> -->
<!-- 				<set name="webAppDir"> -->
<!-- 					<systemproperty default="." name="jetty.home">/webapps</systemproperty> -->
<!-- 				</set> -->
<!-- 				<set name="parentLoaderPriority">false</set> -->
<!-- 				<set name="extract">true</set> -->
<!-- 				<set name="allowDuplicates">false</set> -->
<!-- 				<set name="defaultsDescriptor"> -->
<!-- 					<systemproperty default="." name="jetty.home">/etc/webdefault.xml</systemproperty> -->
<!-- 				</set> -->
<!-- 				<set name="configurationClasses"> -->
<!-- 					<ref id="plusConfig"></ref> -->
<!-- 				</set> -->
<!-- 			</new> -->
<!-- 		</arg> -->
<!-- 	</call> -->
<!-- 	<Call name="addConnector"> -->
<!-- 		<Arg> -->
<!-- 			<New class="org.eclipse.jetty.server.nio.SelectChannelConnector"> -->
<!-- 				<Set name="port">${ugate.web.server.port}</Set> -->
<!-- 			</New> -->
<!-- 		</Arg> -->
<!-- 	</Call> -->
<!-- 	<Set name="handler"> -->
<!-- 		<New class="org.eclipse.jetty.server.handler.HandlerList"> -->
<!-- 			<Set name="handlers"> -->
<!-- 				<Array type="org.eclipse.jetty.server.Handler"> -->
<!-- 					<Item> -->
<!-- 						<New class="org.eclipse.jetty.server.handler.ResourceHandler"> -->
<!-- 							<Set name="directoriesListed">false</Set> -->
<!-- 							<Set name="welcomeFiles"> -->
<!-- 								<Array type="String"> -->
<!-- 									<Item>index.html</Item> -->
<!-- 								</Array> -->
<!-- 							</Set> -->
<!-- 							<Set name="resourceBase">.</Set> -->
<!-- 						</New> -->
<!-- 					</Item> -->
<!-- 					<Item> -->
<!-- 						<New class="org.eclipse.jetty.server.handler.DefaultHandler"> -->
<!-- 						</New> -->
<!-- 					</Item> -->
<!-- 				</Array> -->
<!-- 			</Set> -->
<!-- 		</New> -->
<!-- 	</Set> -->
</Configure>